---
title: "Telecom Report"
author: "Sairam Sasupathi"
date: "1 October 2016"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
original = read.csv("/home/saiviki/R/Assignment/Telecom Data1.csv")
telecom = original
```

Objective
=========
To increase the revenue of a Telecom company using the dataset provided by them.

Introduction
============
The data we have acquired is from the Telecom company who wants their revenue to be improved. Before we dive into making the model, we have to understand the data that we have.


```{r telecom}
summary(telecom)
str(telecom)
```

Data Cleaning
=============
the data needs to be cleaned as there are many variable whose data type is not in the right format or it doesn't comply with the values that those variable hold. Variables that need to be converted from int to factor are region, marital, ed, retire, gender, reside, tollfree, equip, callcard, wireless, multiline, voice, pager, internet, callid, callwait, forward, confer, ebill, custcat, churn.

Variables that need to be converted from factor to numeric are income, longten, tollten, equipten, cardten, wireten.

```{r Data Cleanup and conversion}
# Integer to Factor conversions.
a <- match(c("region", "marital", "ed", "retire", "gender", "reside", "tollfree", "equip",
             "callcard", "wireless", "multline", "voice", "pager", "internet", "callid",
             "callwait", "forward", "confer", "ebill", "custcat", "churn"), names(telecom))
for(i in a)
  telecom[,i] = as.factor(telecom[,i])


# Factor to integer conversions
a <- match(c("income", "longten", "tollten", "equipten", "cardten", "wireten"), names(telecom))
```

The below conversion of data was introducing many NA's. The introduction of NAs are because of some of the values having commas. So the format of the data is changed in the excel so that no NAs are introduced by coercion.  It was not shown for the sake of convenience.

```{r Data Cleanup - cont.}
# Factor to integer conversions (continuation)
for(i in a)
  telecom[,i] = as.numeric(as.character(telecom[,i]))
```

Problem Identification
======================
The business problem has to be understood first before we can suggest what can be improved to increase the revenue. We see that we've different customer categories. Lets analyse and try to understand the different customer categories and the revenue generated by them. Here we're considering the revenue generated by them over the whole tenure, since that will be the only way we can understand the importance of them.

```{r Aggregrate}
# Mean revenue for different customer categories
avr_custcat = aggregate(cbind(longten, tollten, equipten, cardten, wireten) ~ custcat,
                data = telecom, mean)
avr_custcat # Mean revenue
# Median revenue for different customer categories
med_custcat = aggregate(cbind(longten, tollten, equipten, cardten, wireten) ~ custcat,
                        data = telecom, median)
med_custcat # Median revenue
# Total revenue for different customer categories
tot_custcat = aggregate(cbind(longten, tollten, equipten, cardten, wireten) ~ custcat,
                        data = telecom, sum)
tot_custcat # Total revenue

# Percentage of contribution of different services for revenue for each category
tot_revenue = tot_custcat # Copy of total for each customer category
k = c()
k[1] = 10
for(i in 2:6) k[i] = sum(tot_custcat[,i])
percen_revenue = tot_revenue

tot_revenue = rbind(tot_custcat, k)
# Calculating the percentage of revenue
for(i in 2:6)
  for(j in 1:4)
    percen_revenue[j,i] = tot_revenue[j,i]*100/tot_revenue[5,i]

# Printing the data in barplot
barplot(height = c(percen_revenue$longten, percen_revenue$tollten, percen_revenue$equipten,
                   percen_revenue$cardten, percen_revenue$wireten))

```

Customer Category 4 is the highest revenue generator, so they've to be given the most importance. Also, the amount of revenue given from the Customer category 4 is completely spread out across all services. Customer Category 1 are the low revenue generators. Customer Category 2 and 3 create high revenue in some of the revenue streams but they don't use all the services provided by us. Hence, it's important for us to concentrate more on the category 2 and 3 as they're not using all the services as of now. If we could concentrate on moving those customers to the higher category, we can increase the revenue a lot.

Wireless revenue is contributed highest by Customer category 4. Having the highest revenue in only one of the category is not good.

Now, lets analyse the amount of customer churn in each category.

```{r Customer Churn acc to category}
table(telecom$churn, telecom$custcat)
```

This shows that the top revenue generators are the ones who are leaving us. This is not healthy for the financial situation of the company. Hence, it is high time that we move the customers high up the category chain so that we can improve the situation. We can do two things right now.
1. Stopping the Churning customers from leaving us.
2. Move the customers up the category chain, i.e., introduce customers to use more of our other services.

Solution
========

Understanding Churn
-------------------

Among the different Customer categories, we can find out what will be the reason for the churn. Hence, the correlation for the churn can be found.

```{r}
corrplot::corrplot(cor(original[,c(12:15,26:33,36)]))
```

The Correlation matrix shows that we've very slight correlation for the churn with the equip and internet. Also, the internet and the equipment has good correlation between them. But correlation does not mean causation. We've to baseline our claim with some other parameter. Doing a association rule mining to base the relation between churn and these services can be one thing that can be done.

```{r Secondary Service connection}
library(arules)
# Apriori Algorithm for Churning customers according to usage of secondary services
service_matrix = as(object = as.matrix(original[,c(26:33, 36)]), Class = "itemMatrix")
sec_rules = apriori(service_matrix, parameter = list(support = 0.1, confidence = 0.4),
                appearance = list(rhs = "churn", default = "lhs"))
sec_rules = sort(sec_rules, by = "lift")
# interestMeasure(x = sec_rules, transactions = service_matrix)
inspect(sec_rules)

# Apriori Algorithm for Churning customers according to usage of main services
rev_matrix = as(object = as.matrix(original[,c(12:15, 36)]), Class = "itemMatrix")
pri_rules = apriori(rev_matrix, parameter = list(support = 0.1, confidence = 0.4),
                appearance = list(rhs = "churn", default = "lhs"))
pri_rules = sort(pri_rules, by = "lift")
# interestMeasure(x = pri_rules, transactions = rev_matrix)
inspect(pri_rules)
```

This shows that the equipment as a primary service and internet as a secondary service are leading to churn of many customers. Equipment as a service and internet as a secondary service has a lift of greater than 1.5, this shows that it did not happen by chance. If we could provide those customers some discounts on the internet service and equipment cost, they may decide to stay back. This may also stop other staying customers from churning in the future.

Cross-Selling
-------------
With the available data, we can do only the Cross-selling because to do up-selling, we need the rates of different categories. The best way to do Cross sell is to check the association mining for customer category 4 and apply the same in customer category 3.

```{r Creating subsets}
# Subsets of each category of customers
category1 = subset(original, subset = custcat == 1)
category2 = subset(original, subset = custcat == 2)
category3 = subset(original, subset = custcat == 3)
category4 = subset(original, subset = custcat == 4)
```


```{r Cross_selling Category 3}
# Apriori Algorithm for providing new services to the customers in Category 3
service = as(object = as.matrix(category4[,c(12:15)]), Class = "itemMatrix")
rules = apriori(service, parameter = list(support = 0.5, confidence = 0.9))
rules = sort(rules, by = "lift")
# interestMeasure(x = rules, transactions = service)
inspect(rules)
```

For the Customer Category 3, the above combinations will help them to move them to the next category 4.

```{r Cross_selling Category 2}
# Apriori Algorithm for providing new services to the customers in Category 2
service1 = as(object = as.matrix(category3[,c(12:15)]), Class = "itemMatrix")
rules1 = apriori(service1, parameter = list(support = 0.5, confidence = 0.8))
rules1 = sort(rules1, by = "lift")
# interestMeasure(x = rules1, transactions = service1)
inspect(rules1)
```

For the Customer Category 2, the above combinations will help them to move them to the next category 3.

```{r Cross_selling Category 1}
# Apriori Algorithm for providing new services to the customers in Category 1
service2 = as(object = as.matrix(category2[,c(12:15)]), Class = "itemMatrix")
rules2 = apriori(service2, parameter = list(support = 0.4, confidence = 0.6))
rules2 = sort(rules2, by = "lift")
# interestMeasure(x = rules2, transactions = service2)
inspect(rules2)
```

For the Customer Category 1, the above combinations will help them to move them to the next category 2.

Churn Prediction
================
Data Setup
----------
Lets predict the churn for the existing customers. For that, we'll divide the number of customers into churn and not churning customers. Then, out of the not churning customer, we'll take 225 customers for the final prediction which can be used to extrapolate to the 1000 customers. The remaining 501 customers who will not churn and the 274 customers who will churn will be divided into 2 groups of trainset and testset.

```{r division}
churn_customers = subset(telecom, subset = churn == 1)
staying_customers = subset(telecom, subset = churn == 0)
set.seed(16027)
clearsample = staying_customers[502:726,]
trainsample = sample(1:726, 501, replace = FALSE)
total = rbind(staying_customers[1:501,],churn_customers)
trainset = total[trainsample,]
testset = total[-trainsample,]
```

Feature Selection
-----------------
Selecting the variables for the program.

```{r Feature Selection}
library(rpart)
library(caret)
library(rattle)
cnt = rpart.control(xval = 10, cp = 0.0125, surrogatestyle = 1, usesurrogate = 2, maxsurrogate = 10)
model1=rpart(formula = churn~.,data = trainset, control = cnt)
pred_model1=predict(model1,newdata = testset,type="class")
rattle::fancyRpartPlot(model1)
confusionMatrix(pred_model1,testset$churn)
```

From the model generated above, the variables selected are the ones at the top of the tree. They are longten, equipten, cardten, tollten, address, age and income.

Model Generation using caret
----------------------------

```{r Loops}
cntrl=trainControl(method = "cv",number=10)
model2=train(churn ~ longten + equipten + cardten + tollten + address + age + income
             ,data=trainset,method="rpart",trControl=cntrl,metric="Kappa")
pred_model2=predict(model2,newdata=testset)
confusionMatrix(pred_model2,testset$churn)
```

The model generated has accuracy of 72% with a very good sensitivity to find the people who might churn in the future. Hence we can use this model to predict in the dataset we have taken.

```{r}
pred = predict(model2, newdata = clearsample)
confusionMatrix(pred, clearsample$churn)
```

We find that out of the 225 customers that we have taken, 31 will be churning. Extrapolating this to the 1000 customers, we'll get 138 customers or 13.8% of your customer base. This will greatly help in reducing the revenue loss for the company.

Conclusion
==========

Based on the understanding that we have created about the reason for the churning of the customers, the services of Internet and the Equipment has to be improved to retain the customers who are churning. The different cross selling ideas are generated for different customer categories using the higher customer category, so that we can move the customer to the higher customer category. After understanding the reason why the customers are churning, the model for churn of the existing customers is built. Based on the association algorithm used and the model built, we can largely assume that  if we apply the strategy of moving the customers to higher category, we can, to an extent, reduce churn. Luring customers with right offers and products will help increase our revenue.
